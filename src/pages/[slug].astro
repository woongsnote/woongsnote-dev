---
import PostLayout from '@/app/layouts/PostLayout.astro';
import { parseMinutes } from '@/shared/lib/content/posts';
import { getPostBySlug, getPosts } from '@/shared/lib/content/posts.query';
import { seo } from '@/shared/lib/seo';
import { postToSeoSource } from '@/shared/lib/seo/adapter/post';
import type { GetStaticPaths } from 'astro';
import { render } from 'astro:content';

export const getStaticPaths = (async () => {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.id },
  }));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;

const post = await getPostBySlug(slug!);

if (!post) {
  throw new Error(`Post not found: ${slug}`);
}

const meta = seo.post(postToSeoSource(post));

const { Content, headings, remarkPluginFrontmatter } = await render(post);

const readingTime = parseMinutes(remarkPluginFrontmatter.minutesRead);
---

<PostLayout
  meta={meta}
  post={post}
  headings={headings}
  readingTime={readingTime}
>
  <Content />
</PostLayout>
